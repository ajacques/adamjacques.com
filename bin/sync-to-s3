#!/usr/bin/env ruby

require 'aws-sdk-s3'
require 'json'
require 'net/http'
require 'sentry-ruby'

Sentry.init do |_config|
end

extensions = %w[.css .js .mp4]

bucket = Aws::S3::Resource.new.bucket(ENV['S3_BUCKET_NAME'])

def assets_files
  Dir.glob('public/assets/.sprockets-manifest-*.json').map do |manifest|
    JSON.parse(File.read(manifest))['files'].keys
  end.flatten
end

def webpacker_files
  JSON.parse(File.read('public/packs/manifest.json')).filter_map do |_key, value|
    value if value.is_a? String
  end
end

def log(message)
  puts message
  Sentry.add_breadcrumb(Sentry::Breadcrumb.new(message: message))
end

def upload_asset(bucket, file, opts = {})
  mimes = {
    '.js' => 'application/javascript',
    '.css' => 'text/css',
    '.mp4' => 'video/mp4',
    '.html' => 'text/html'
  }
  mime = mimes[File.extname(file)]
  log "Uploading #{file}"
  bucket
    .object("web_content/#{file}")
    .upload_file("./public/#{file}", opts.merge(content_type: mime))
end

def http_get
  url = URI.parse(ENV['URI'])
  response = Net::HTTP.get_response(url)
  raise 'Non 200 from website' unless response.code == '200'
  response.value
end

begin
  assets = []
  assets.concat(assets_files)
  assets.concat(webpacker_files)

  assets
    .select { |file| extensions.include? File.extname(file) }
    .map do |file|
    upload_asset(bucket, "assets/#{file}", cache_control: 'max-age=31556926')
  end

  bucket.object('web_content/index.html').put(
    body: http_get,
    cache_control: 'max-age=3600',
    content_type: 'text/html'
  )
rescue Exception => ex
  puts ex
  Sentry.capture_exception(ex)
  raise ex
end